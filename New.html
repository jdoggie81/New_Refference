<!DOCTYPE html>
<!-- saved from url=(0066)file:///C:/Users/Rian%20Higgins/Desktop/BTC%20DASH%20TEST%201.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Liquidity Dashboard</title>
    <script src="file:///C:/Users/Rian%20Higgins/Desktop/Advanced%20Liquidity%20Dashboard_files/plotly-latest.min.js.download"></script>
    <script src="file:///C:/Users/Rian%20Higgins/Desktop/Advanced%20Liquidity%20Dashboard_files/tf.min.js.download"></script>
    <script src="file:///C:/Users/Rian%20Higgins/Desktop/Advanced%20Liquidity%20Dashboard_files/luxon@2.0.2"></script>
    <style>
        :root {
            --dark-bg: #0a0a1a;
            --panel-bg: rgba(0, 0, 0, 0.3);
            --text-main: #a0e0ff;
            --text-secondary: #ff8c00;
            --positive: #39FF14;
            --negative: #FF3131;
            --warning: #ffff00;
            --highlight-blue: rgba(0, 150, 255, 0.2);
            --highlight-purple: rgba(128, 0, 128, 0.3);
            --highlight-ask: rgba(0, 255, 0, 0.3);
            --highlight-bid: rgba(255, 0, 0, 0.3);
            --highlight-neon-green: rgba(57, 255, 20, 0.3);
            --accent-blue: #00F5FF;
            --neon-red: #FF3131;
            --accent-orange: #E58C23;
            --grid-line: rgba(160, 224, 255, 0.15);
            --flash-bg: rgba(255, 255, 255, 0.7);
            --gold-alert: rgba(255, 215, 0, 0.5);
            --light-blue-alert: rgba(173, 216, 230, 0.5);
            --silver-text: #C0C0C0;
            --reconnecting: #FFA500;
        }

        body {
            background: var(--dark-bg);
            color: var(--text-main);
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 10px;
            overflow: hidden;
            user-select: none;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            width: 100%;
            height: 100vh;
        }

        .panel {
            background: var(--panel-bg);
            border-radius: 8px;
            border: 1px solid var(--grid-line);
            padding: 15px;
            position: absolute;
            resize: both;
            overflow: auto;
            min-width: 300px;
            min-height: 200px;
        }

        .panel-header {
            cursor: move;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--grid-line);
            margin-bottom: 10px;
            color: var(--text-main);
            font-weight: bold;
            font-size: 18px;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        /* Connection status animations */
        .panel-header.connection-lost {
            animation: pulse-border 2s infinite;
        }

        .panel-header.reconnecting {
            animation: chase-border 3s infinite linear;
        }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 5px var(--negative); }
            50% { box-shadow: 0 0 20px var(--negative); }
            100% { box-shadow: 0 0 5px var(--negative); }
        }

        @keyframes chase-border {
            0% { box-shadow: 0 0 5px var(--reconnecting) inset; }
            25% { box-shadow: 0 -5px 5px var(--reconnecting) inset; }
            50% { box-shadow: -5px 0 5px var(--reconnecting) inset; }
            75% { box-shadow: 0 5px 5px var(--reconnecting) inset; }
            100% { box-shadow: 5px 0 5px var(--reconnecting) inset; }
        }

        .connection-status {
            font-size: 12px;
            margin-left: 10px;
            font-weight: normal;
        }

        .connection-status.connected {
            color: var(--positive);
        }

        .connection-status.disconnected {
            color: var(--negative);
        }

        .connection-status.reconnecting {
            color: var(--reconnecting);
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Color picker styles */
        .color-picker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            cursor: pointer;
            margin-left: 5px;
            border: 1px solid var(--grid-line);
        }

        .color-option {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        /* Filter controls enhancements */
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-label {
            font-size: 11px;
        }

        .filter-input {
            width: 60px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-main);
            border: 1px solid var(--grid-line);
            border-radius: 3px;
            padding: 3px;
        }

        .filter-select {
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-main);
            border: 1px solid var(--grid-line);
            border-radius: 3px;
            padding: 3px;
            min-width: 70px;
        }

        /* Rest of your existing styles... */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        ::-webkit-scrollbar-track {
            background: var(--panel-bg);
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, 
                #FF3131, #FF9131, #FFD131, #39FF14, #00F5FF, #BF40BF);
            border-radius: 6px;
        }

        .tape {
            height: calc(100% - 40px);
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .tape-row {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .buy-row {
            background-color: var(--highlight-blue);
            color: var(--accent-blue);
        }

        .sell-row {
            background-color: var(--highlight-bid);
            color: var(--neon-red);
        }

        .above-ask {
            background-color: rgba(0, 100, 255, 0.3);
        }

        .below-bid {
            background-color: rgba(70, 70, 100, 0.3);
        }

        .info-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 16px;
            color: var(--text-main);
        }

        .info-sublabel {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .info-value {
            font-size: 18px;
            font-weight: bold;
        }

        .positive-value {
            color: var(--positive);
        }

        .negative-value {
            color: var(--negative);
        }

        .warning-value {
            color: var(--warning);
        }

        .info-value-small {
            font-size: 14px;
        }

        .silver-text {
            color: var(--silver-text);
        }

        .slippage-indicator {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
        }

        .bid-slippage {
            color: var(--negative);
            text-shadow: 0 0 5px rgba(255, 49, 49, 0.7);
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 3px;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .ask-slippage {
            color: var(--positive);
            text-shadow: 0 0 5px rgba(57, 255, 20, 0.7);
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 3px;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .price-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .price-box {
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid var(--grid-line);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            margin: 0;
        }

        .dpeg-tape .tape-row {
            font-family: monospace;
            padding: 3px;
            display: flex;
            justify-content: space-between;
        }

        .large-buy-row {
            background-color: rgba(0, 255, 0, 0.3);
            color: #39FF14;
        }

        .large-sell-row {
            background-color: rgba(255, 0, 0, 0.3);
            color: #FF3131;
        }

        .gold-alert {
            background-color: var(--gold-alert) !important;
        }

        .light-blue-alert {
            background-color: var(--light-blue-alert) !important;
        }

        .purple-alert {
            background-color: var(--highlight-purple) !important;
        }
        
        .neon-green-alert {
            background-color: var(--highlight-neon-green) !important;
        }
        
        .market-update-board {
            grid-column: 1 / span 2;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--grid-line);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 10px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--accent-blue);
            bottom: 0;
            right: 0;
            cursor: nwse-resize;
            z-index: 10;
        }

         /* ==================== NEW STYLES FOR ENHANCED CONTROLS ==================== */
        /* Enhanced Color Picker Modal */
        #color-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background: var(--panel-bg);
            margin: 10% auto;
            padding: 20px;
            border: 1px solid var(--grid-line);
            width: 320px;
            border-radius: 8px;
        }

        /* Expanded Color Palette */
        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-option.selected {
            border-color: var(--text-main);
            transform: scale(1.1);
        }

        /* Transparency Slider */
        .transparency-control {
            margin: 15px 0;
        }

        .transparency-slider {
            width: 100%;
            margin-top: 5px;
        }

        /* Filter Controls in Modal */
        .filter-modal-section {
            margin: 15px 0;
            border-top: 1px solid var(--grid-line);
            padding-top: 15px;
        }

        .filter-group-modal {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .filter-label-modal {
            width: 100px;
            font-size: 12px;
        }

        /* Tape Controls Button */
        .tape-controls-btn {
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-main);
            border: 1px solid var(--grid-line);
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 5px;
        }

        .modal-btn {
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-main);
            border: 1px solid var(--grid-line);
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .modal-btn:hover {
            background: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Info Panel -->
        <div class="panel" id="info-panel" style="top: -1px; left: 553px; width: 344px; height: 558px;">
            <div class="panel-header">
                <span>Market Information</span>
                <div class="price-box">
                    <span class="info-value"><span id="last-price-display" class="negative-value">102303.20</span></span>
                </div>
            </div>
            <div class="info-container" id="market-info">
                <div class="market-update-board" id="market-updates"><span style="color:#FFA500">↻ Aggregated Trade stream reconnecting...</span></div>
                <div class="info-item">
                    <div class="bid-slippage" id="bid-slippage">Selling: -0.41%</div>
                </div>
                <div class="info-item">
                    <div class="ask-slippage" id="ask-slippage">Buying: 0.81%</div>
                </div>
                
                <div class="info-item">
                    <span class="info-label">15m Sells</span>
                    <span class="info-value"><span class="negative-value" id="sells-15m">17.3535</span></span>
                    <span class="info-sublabel"><span class="negative-value" id="sells-15m-usd">$1,777,598.40</span></span>
                </div>
                <div class="info-item">
                    <span class="info-label">15m Buys</span>
                    <span class="info-value"><span class="positive-value" id="buys-15m">61.3041</span></span>
                    <span class="info-sublabel"><span class="positive-value" id="buys-15m-usd">$6,281,457.08</span></span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">DPeg CVD</span>
                    <span class="info-value"><span class="negative-value" id="dpeg-cvd">-0.03036</span></span>
                    <span class="info-sublabel"><span class="negative-value" id="dpeg-cvd-usd">$-3,086.86</span></span>
                </div>
                <div class="info-item">
                    <span class="info-label">POC</span>
                    <span class="info-value"><span class="info-value-small" id="poc">$49650.00</span></span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">VAL</span>
                    <span class="info-value"><span class="info-value-small" id="val">$49500.00</span></span>
                </div>
                <div class="info-item">
                    <span class="info-label">VAH</span>
                    <span class="info-value"><span class="info-value-small" id="vah">$50250.00</span></span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">CVD (4H)</span>
                    <span class="info-value"><span class="negative-value" id="cvd-4h">$(13,691,930.20)</span></span>
                </div>
                <div class="info-item">
                    <span class="info-label">CVD (15m)</span>
                    <span class="info-value"><span class="negative-value" id="cvd-15m">$4,503,858.68</span></span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">Intraday VWAP</span>
                    <span class="info-value"><span class="warning-value" id="intraday-vwap">$50000.00</span></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Daily VWAP</span>
                    <span class="info-value"><span class="warning-value" id="daily-vwap">$49900.00</span></span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">4H Bar Close</span>
                    <span class="info-value" id="bar-close-4h">191:08</span>
                </div>
                <div class="info-item">
                    <span class="info-label">15m Bar Close</span>
                    <span class="info-value" id="bar-close-15m">11:08</span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">UTC-5</span>
                    <span class="info-value" id="utc-time">8:12:57 PM</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Next Analysis</span>
                    <span class="info-value" id="next-analysis">01:08</span>
                </div>
            </div>
        <div class="resize-handle"></div></div>

        <!-- Time & Sales Tape -->
        <div class="panel" id="trades-panel" style="top: 700px; left: 1590px; width: 302px; height: 208px;">
            <div class="panel-header reconnecting">
                <span>Time &amp; Sales</span>
                <span id="trade-status" class="connection-status reconnecting">↻ Reconnecting</span>
            </div>
            <div class="tape" id="trades-tape"><div class="tape-row sell-row">
                    <span>0.0358</span>
                    <span>8:11:29 PM</span>
                    <span>102303.20</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102305.00</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102305.01</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0466</span>
                    <span>8:11:29 PM</span>
                    <span>102305.01</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102305.75</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102307.70</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0049</span>
                    <span>8:11:29 PM</span>
                    <span>102307.73</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102307.75</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102308.50</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102308.51</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102308.51</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102309.46</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0782</span>
                    <span>8:11:29 PM</span>
                    <span>102309.46</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102309.47</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102309.47</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102309.47</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0015</span>
                    <span>8:11:29 PM</span>
                    <span>102310.08</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0030</span>
                    <span>8:11:29 PM</span>
                    <span>102311.64</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0013</span>
                    <span>8:11:29 PM</span>
                    <span>102311.98</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0010</span>
                    <span>8:11:29 PM</span>
                    <span>102312.84</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0008</span>
                    <span>8:11:29 PM</span>
                    <span>102312.84</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102314.00</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102314.00</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102314.00</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0010</span>
                    <span>8:11:29 PM</span>
                    <span>102312.84</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0010</span>
                    <span>8:11:29 PM</span>
                    <span>102312.84</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0010</span>
                    <span>8:11:29 PM</span>
                    <span>102312.84</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102314.00</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102314.01</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102314.01</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102314.01</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102314.01</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102315.45</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0004</span>
                    <span>8:11:29 PM</span>
                    <span>102315.91</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102316.28</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0059</span>
                    <span>8:11:29 PM</span>
                    <span>102316.28</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102316.76</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102316.77</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102317.45</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102317.46</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102317.46</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102317.46</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0047</span>
                    <span>8:11:29 PM</span>
                    <span>102317.46</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0523</span>
                    <span>8:11:29 PM</span>
                    <span>102317.46</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102317.47</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102317.47</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102317.47</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102317.47</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102317.50</span>
                    <span>SELL</span>
                </div><div class="tape-row sell-row">
                    <span>0.0001</span>
                    <span>8:11:29 PM</span>
                    <span>102317.95</span>
                    <span>SELL</span>
                </div></div>
        <div class="resize-handle"></div></div>

        <!-- Aggregated Trades Tape -->
        <div class="panel" id="agg-trades-panel" style="top: 2px; left: 1584px; width: 317px; height: 661px;">
            <div class="panel-header reconnecting">
                <span>Aggregated Trades</span>
                <span id="aggTrade-status" class="connection-status reconnecting">↻ Reconnecting</span>
            </div>
            <div class="filter-controls">
                <div class="filter-group">
                    <span class="filter-label">Volume Min:</span>
                    <input type="number" id="agg-min" min="0" max="10000" value="0" class="filter-input">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Volume Max:</span>
                    <input type="number" id="agg-max" min="0" max="10000" value="10000" class="filter-input">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Alert 1:</span>
                    <select id="agg-alert-type1" class="filter-select">
                        <option value="none">None</option>
                        <option value="bid">Bid</option>
                        <option value="ask">Ask</option>
                        <option value="volume">Volume</option>
                    </select>
                    <input type="number" id="agg-alert-min1" min="0" max="10000" value="0" class="filter-input">
                    <input type="number" id="agg-alert-max1" min="0" max="10000" value="10000" class="filter-input">
                    <div class="color-picker" id="agg-color1" title="Select color for Alert 1">
                        <div class="color-option" style="background-color: rgb(30, 144, 255);"></div>
                    </div>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Alert 2:</span>
                    <select id="agg-alert-type2" class="filter-select">
                        <option value="none">None</option>
                        <option value="bid">Bid</option>
                        <option value="ask">Ask</option>
                        <option value="volume">Volume</option>
                    </select>
                    <input type="number" id="agg-alert-min2" min="0" max="10000" value="0" class="filter-input">
                    <input type="number" id="agg-alert-max2" min="0" max="10000" value="10000" class="filter-input">
                    <div class="color-picker" id="agg-color2" title="Select color for Alert 2">
                        <div class="color-option" style="background-color: rgb(255, 140, 0);"></div>
                    </div>
                </div>
            </div>
            <div class="tape" id="agg-trades-tape"><div class="tape-row buy-row" style="">
                        <span>0.2122</span>
                        <span>8:12:14 PM</span>
                        <span>102380.96</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.1371</span>
                        <span>8:12:13 PM</span>
                        <span>102373.28</span>
                        <span>BUY</span>
                    </div><div class="tape-row sell-row" style="box-shadow: rgb(255, 140, 0) 0px 0px 10px;">
                        <span>2.0195</span>
                        <span>8:12:07 PM</span>
                        <span>102373.27</span>
                        <span>SELL</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.3821</span>
                        <span>8:12:05 PM</span>
                        <span>102374.30</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.1539</span>
                        <span>8:12:05 PM</span>
                        <span>102373.98</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.4372</span>
                        <span>8:12:05 PM</span>
                        <span>102373.94</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.1114</span>
                        <span>8:12:05 PM</span>
                        <span>102373.75</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.2311</span>
                        <span>8:12:05 PM</span>
                        <span>102373.60</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.2930</span>
                        <span>8:12:05 PM</span>
                        <span>102373.59</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.4578</span>
                        <span>8:12:05 PM</span>
                        <span>102373.24</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.7033</span>
                        <span>8:12:05 PM</span>
                        <span>102369.95</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.1914</span>
                        <span>8:12:05 PM</span>
                        <span>102369.94</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.1914</span>
                        <span>8:12:05 PM</span>
                        <span>102369.74</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>1.5325</span>
                        <span>8:12:05 PM</span>
                        <span>102369.53</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>1.2682</span>
                        <span>8:12:05 PM</span>
                        <span>102369.16</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.1499</span>
                        <span>8:12:05 PM</span>
                        <span>102368.60</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.1914</span>
                        <span>8:12:05 PM</span>
                        <span>102366.82</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.7033</span>
                        <span>8:12:05 PM</span>
                        <span>102365.24</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.3542</span>
                        <span>8:12:05 PM</span>
                        <span>102365.23</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.1914</span>
                        <span>8:12:05 PM</span>
                        <span>102365.22</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.4372</span>
                        <span>8:12:05 PM</span>
                        <span>102361.35</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.6447</span>
                        <span>8:12:05 PM</span>
                        <span>102360.39</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row" style="">
                        <span>0.3528</span>
                        <span>8:12:05 PM</span>
                        <span>102360.38</span>
                        <span>BUY</span>
                    </div></div>
        <div class="resize-handle"></div></div>

        <!-- Cumulative Tape -->
        <div class="panel" id="cumulative-panel" style="top: 378px; left: 5px; width: 436px; height: 535px;">
            <div class="panel-header">
                <span>Cumulative Trades</span>
                <span id="trade-status" class="connection-status disconnected">○ Disconnected</span>
            </div>
            <div class="filter-controls">
                <div class="filter-group">
                    <span class="filter-label">Alert On:</span>
                    <select id="cumulative-alert-type1" class="filter-select">
                        <option value="none">None</option>
                        <option value="bid">Bid</option>
                        <option value="ask">Ask</option>
                        <option value="volume">Volume</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Min Size:</span>
                    <input type="number" id="cumulative-min1" min="0" max="100000" value="5" class="filter-input">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Max Size:</span>
                    <input type="number" id="cumulative-max1" min="0" max="100000" value="100000" class="filter-input">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Color:</span>
                    <div class="color-picker" id="cumulative-color1" title="Select color for Alert 1">
                        <div class="color-option" style="background-color: rgb(255, 0, 255);"></div>
                    </div>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Alert On:</span>
                    <select id="cumulative-alert-type2" class="filter-select">
                        <option value="none">None</option>
                        <option value="bid">Bid</option>
                        <option value="ask">Ask</option>
                        <option value="volume">Volume</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Min Size:</span>
                    <input type="number" id="cumulative-min2" min="0" max="100000" value="10" class="filter-input">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Max Size:</span>
                    <input type="number" id="cumulative-max2" min="0" max="100000" value="50000" class="filter-input">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Color:</span>
                    <div class="color-picker" id="cumulative-color2" title="Select color for Alert 2">
                        <div class="color-option" style="background-color: rgb(57, 255, 20);"></div>
                    </div>
                </div>
            </div>
            <div class="tape" id="cumulative-tape"><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:18 PM</span>
                        <span>102393.92</span>
                        <span>BUY</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0272</span>
                        <span>8:12:18 PM</span>
                        <span>102393.91</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0006</span>
                        <span>8:12:18 PM</span>
                        <span>102393.91</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0024</span>
                        <span>8:12:17 PM</span>
                        <span>102393.91</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0098</span>
                        <span>8:12:17 PM</span>
                        <span>102393.91</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0046</span>
                        <span>8:12:17 PM</span>
                        <span>102393.91</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0001</span>
                        <span>8:12:17 PM</span>
                        <span>102393.91</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0001</span>
                        <span>8:12:16 PM</span>
                        <span>102393.91</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0001</span>
                        <span>8:12:16 PM</span>
                        <span>102393.91</span>
                        <span>SELL</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0004</span>
                        <span>8:12:14 PM</span>
                        <span>102393.91</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102392.78</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0009</span>
                        <span>8:12:14 PM</span>
                        <span>102392.64</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0024</span>
                        <span>8:12:14 PM</span>
                        <span>102392.00</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0008</span>
                        <span>8:12:14 PM</span>
                        <span>102391.99</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102391.84</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0049</span>
                        <span>8:12:14 PM</span>
                        <span>102391.20</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102391.02</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0003</span>
                        <span>8:12:14 PM</span>
                        <span>102391.01</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102390.23</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0015</span>
                        <span>8:12:14 PM</span>
                        <span>102389.10</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102388.18</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0004</span>
                        <span>8:12:14 PM</span>
                        <span>102388.13</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0024</span>
                        <span>8:12:14 PM</span>
                        <span>102388.00</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0006</span>
                        <span>8:12:14 PM</span>
                        <span>102387.99</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0010</span>
                        <span>8:12:14 PM</span>
                        <span>102387.98</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0060</span>
                        <span>8:12:14 PM</span>
                        <span>102387.59</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0002</span>
                        <span>8:12:14 PM</span>
                        <span>102387.58</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102387.44</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102386.13</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0011</span>
                        <span>8:12:14 PM</span>
                        <span>102386.09</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0411</span>
                        <span>8:12:14 PM</span>
                        <span>102386.08</span>
                        <span>BUY</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0019</span>
                        <span>8:12:14 PM</span>
                        <span>102386.07</span>
                        <span>SELL</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0071</span>
                        <span>8:12:14 PM</span>
                        <span>102386.08</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102386.08</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102385.11</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0007</span>
                        <span>8:12:14 PM</span>
                        <span>102384.16</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102384.08</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0026</span>
                        <span>8:12:14 PM</span>
                        <span>102384.00</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0002</span>
                        <span>8:12:14 PM</span>
                        <span>102383.98</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102383.97</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102383.07</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102383.06</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102383.06</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0005</span>
                        <span>8:12:14 PM</span>
                        <span>102383.01</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102382.62</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0004</span>
                        <span>8:12:14 PM</span>
                        <span>102382.61</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0007</span>
                        <span>8:12:14 PM</span>
                        <span>102382.48</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0023</span>
                        <span>8:12:14 PM</span>
                        <span>102382.47</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102382.46</span>
                        <span>BUY</span>
                    </div><div class="tape-row buy-row">
                        <span>0.0001</span>
                        <span>8:12:14 PM</span>
                        <span>102382.03</span>
                        <span>BUY</span>
                    </div></div>
        <div class="resize-handle"></div></div>

        <!-- Market Orders Tape -->
        <div class="panel" id="market-orders-panel" style="top: 1px; left: 946px; width: 604px; height: 919px;">
            <div class="panel-header">
                <span>Market Orders</span>
                <span id="trade-status" class="connection-status disconnected">○ Disconnected</span>
            </div>
            <div class="filter-controls">
                <div class="filter-group">
                    <span class="filter-label">Alert On:</span>
                    <select id="market-alert-type1" class="filter-select">
                        <option value="none">None</option>
                        <option value="bid">Bid</option>
                        <option value="ask">Ask</option>
                        <option value="volume">Volume</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Min Size:</span>
                    <input type="number" id="market-min1" min="0" max="100000" value="1" class="filter-input">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Max Size:</span>
                    <input type="number" id="market-max1" min="0" max="100000" value="100000" class="filter-input">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Color:</span>
                    <div class="color-picker" id="market-color1" title="Select color for Alert 1">
                        <div class="color-option" style="background-color: rgb(191, 64, 191);"></div>
                    </div>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Alert On:</span>
                    <select id="market-alert-type2" class="filter-select">
                        <option value="none">None</option>
                        <option value="bid">Bid</option>
                        <option value="ask">Ask</option>
                        <option value="volume">Volume</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Min Size:</span>
                    <input type="number" id="market-min2" min="0" max="100000" value="5" class="filter-input">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Max Size:</span>
                    <input type="number" id="market-max2" min="0" max="100000" value="50000" class="filter-input">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Color:</span>
                    <div class="color-picker" id="market-color2" title="Select color for Alert 2">
                        <div class="color-option" style="background-color: rgb(57, 255, 20);"></div>
                    </div>
                </div>
            </div>
            <div class="tape" id="market-orders-tape"><div class="tape-row sell-row">
                        <span>0.0358</span>
                        <span>8:11:29 PM</span>
                        <span>102303.20</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0466</span>
                        <span>8:11:29 PM</span>
                        <span>102305.01</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0049</span>
                        <span>8:11:29 PM</span>
                        <span>102307.73</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0782</span>
                        <span>8:11:29 PM</span>
                        <span>102309.46</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0015</span>
                        <span>8:11:29 PM</span>
                        <span>102310.08</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0030</span>
                        <span>8:11:29 PM</span>
                        <span>102311.64</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0013</span>
                        <span>8:11:29 PM</span>
                        <span>102311.98</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0010</span>
                        <span>8:11:29 PM</span>
                        <span>102312.84</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0010</span>
                        <span>8:11:29 PM</span>
                        <span>102312.84</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0010</span>
                        <span>8:11:29 PM</span>
                        <span>102312.84</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0010</span>
                        <span>8:11:29 PM</span>
                        <span>102312.84</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0059</span>
                        <span>8:11:29 PM</span>
                        <span>102316.28</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0047</span>
                        <span>8:11:29 PM</span>
                        <span>102317.46</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0523</span>
                        <span>8:11:29 PM</span>
                        <span>102317.46</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0010</span>
                        <span>8:11:29 PM</span>
                        <span>102317.96</span>
                        <span>SELL</span>
                    </div><div class="tape-row sell-row">
                        <span>0.0010</span>
                        <span>8:11:29 PM</span>
                        <span>102317.96</span>
                        <span>SELL</span>
                    </div></div>
        <div class="resize-handle"></div></div>

        <!-- DPeg Analysis -->
        <div class="panel dpeg-tape" id="dpeg-panel" style="top: 530px; left: 480px; width: 449px; height: 404px;">
            <div class="panel-header">
                <span>DPeg Analysis</span>
                <span id="trade-status" class="connection-status disconnected">○ Disconnected</span>
            </div>
            <div class="filter-controls">
                <div class="filter-group">
                    <span class="filter-label">Buy Threshold:</span>
                    <input type="number" id="dpeg-buy-thresh" step="0.00001" value="0.00006" class="filter-input">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Sell Threshold:</span>
                    <input type="number" id="dpeg-sell-thresh" step="0.00001" value="0.00008" class="filter-input">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Slippage Ticks:</span>
                    <input type="number" id="dpeg-slippage" min="0" max="20000" value="1000" class="filter-input">
                </div>
                <button id="start-dpeg" style="background: rgba(0, 255, 0, 0.2); color: var(--text-main); border: 1px solid var(--grid-line); border-radius: 3px; padding: 3px 6px;">CVD Running</button>
                <button id="reset-dpeg" style="background: rgba(0,0,0,0.3); color: var(--text-main); border: 1px solid var(--grid-line); border-radius: 3px; padding: 3px 6px;">Reset CVD</button>
            </div>
            <div class="tape" id="dpeg-tape"><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102305.00</span>
                    <span>(Slippage: -0.41%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102305.01</span>
                    <span>(Slippage: -0.41%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102305.75</span>
                    <span>(Slippage: -0.41%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102308.50</span>
                    <span>(Slippage: -0.41%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102308.51</span>
                    <span>(Slippage: -0.41%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102309.46</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102309.47</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102309.47</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102309.47</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102314.00</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102314.01</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102314.01</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102314.01</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102316.76</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102316.77</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.45</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.46</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.46</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.47</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.47</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.47</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.47</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.50</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.95</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.95</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.95</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.95</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.95</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.95</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.95</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.95</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.95</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.95</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:29 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.96</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102317.97</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102318.53</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102319.00</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102319.01</span>
                    <span>(Slippage: -0.40%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102320.02</span>
                    <span>(Slippage: -0.39%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102321.39</span>
                    <span>(Slippage: -0.39%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102321.39</span>
                    <span>(Slippage: -0.39%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102321.39</span>
                    <span>(Slippage: -0.39%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102321.39</span>
                    <span>(Slippage: -0.39%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102321.39</span>
                    <span>(Slippage: -0.39%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102321.39</span>
                    <span>(Slippage: -0.39%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102321.39</span>
                    <span>(Slippage: -0.39%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102321.39</span>
                    <span>(Slippage: -0.39%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102321.39</span>
                    <span>(Slippage: -0.39%)</span>
                </div><div class="tape-row sell-row">
                    <span>[08:11:28 PM]</span>
                    <span>SELL 0.00006 BTC @ 102321.39</span>
                    <span>(Slippage: -0.39%)</span>
                </div></div>
        <div class="resize-handle"></div></div>

        <!-- Large Orders Tape -->
        <div class="panel" id="large-orders-panel" style="top: 7px; left: 7px; width: 514px; height: 393px;">
            <div class="panel-header">
                <span>Large Orders</span>
                <span id="trade-status" class="connection-status disconnected">○ Disconnected</span>
            </div>
            <div class="filter-controls">
                <div class="filter-group">
                    <span class="filter-label">Min Size (BTC):</span>
                    <input type="number" id="large-min" min="0" max="1000" value="5" step="0.1" class="filter-input">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Max Size (BTC):</span>
                    <input type="number" id="large-max" min="0" max="1000" value="1000" step="0.1" class="filter-input">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Volume Alert 1:</span>
                    <input type="number" id="large-volume-alert1" min="0" max="100000" value="0" class="filter-input">
                    <div class="color-picker" id="large-color1" title="Select color for Alert 1">
                        <div class="color-option" style="background-color: #FFD700;"></div>
                    </div>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Volume Alert 2:</span>
                    <input type="number" id="large-volume-alert2" min="0" max="100000" value="0" class="filter-input">
                    <div class="color-picker" id="large-color2" title="Select color for Alert 2">
                        <div class="color-option" style="background-color: rgb(255, 49, 49);"></div>
                    </div>
                </div>
            </div>
            <div class="tape" id="large-orders-tape"><div class="tape-row large-buy-row">
                        <span>1.02</span>
                        <span>8:11:15 PM</span>
                        <span>102266.90</span>
                        <span>BUY</span>
                    </div><div class="tape-row large-buy-row">
                        <span>1.53</span>
                        <span>8:02:22 PM</span>
                        <span>102424.17</span>
                        <span>BUY</span>
                    </div><div class="tape-row large-sell-row">
                        <span>1.19</span>
                        <span>7:53:49 PM</span>
                        <span>102169.11</span>
                        <span>SELL</span>
                    </div><div class="tape-row large-sell-row">
                        <span>1.53</span>
                        <span>7:53:49 PM</span>
                        <span>102170.80</span>
                        <span>SELL</span>
                    </div><div class="tape-row large-buy-row">
                        <span>1.66</span>
                        <span>7:49:50 PM</span>
                        <span>102392.65</span>
                        <span>BUY</span>
                    </div><div class="tape-row large-sell-row">
                        <span>1.53</span>
                        <span>7:44:31 PM</span>
                        <span>102312.02</span>
                        <span>SELL</span>
                    </div><div class="tape-row large-sell-row">
                        <span>1.19</span>
                        <span>7:44:31 PM</span>
                        <span>102312.03</span>
                        <span>SELL</span>
                    </div><div class="tape-row large-sell-row">
                        <span>1.53</span>
                        <span>7:44:31 PM</span>
                        <span>102318.02</span>
                        <span>SELL</span>
                    </div><div class="tape-row large-sell-row">
                        <span>1.06</span>
                        <span>7:44:31 PM</span>
                        <span>102318.03</span>
                        <span>SELL</span>
                    </div><div class="tape-row large-buy-row" style="background-color: rgba(255, 215, 0, 0.267); box-shadow: rgb(255, 49, 49) 0px 0px 10px;">
                        <span>5.57</span>
                        <span>2:48:45 PM</span>
                        <span>101850.14</span>
                        <span>BUY</span>
                    </div><div class="tape-row large-buy-row" style="background-color: rgba(255, 215, 0, 0.267); box-shadow: rgb(255, 49, 49) 0px 0px 10px;">
                        <span>6.24</span>
                        <span>2:48:45 PM</span>
                        <span>101850.14</span>
                        <span>BUY</span>
                    </div></div>
        <div class="resize-handle"></div></div>
    </div>

    <!-- Color Palette Modal (NEW) -->
    <div id="color-modal">
        <div class="modal-content">
            <h3 style="margin-top: 0;">Tape Controls</h3>
            <div class="filter-modal-section">
                <h4>Color Selection</h4>
                <div class="color-palette" id="color-palette">
                    <!-- Colors will be inserted by JavaScript -->
                </div>
            </div>
            <div class="filter-modal-section">
                <h4>Transparency</h4>
                <div class="transparency-control">
                    <label class="filter-label-modal">Highlight Opacity:</label>
                    <input type="range" min="0" max="100" value="30" class="transparency-slider" id="transparency-slider">
                </div>
            </div>
            <div class="filter-modal-section">
                <h4>Filters</h4>
                <div id="dynamic-filters"></div>
            </div>
            <div style="margin-top: 15px; display: flex; justify-content: space-between;">
                <button id="color-cancel" class="modal-btn">Cancel</button>
                <button id="color-confirm" class="modal-btn">Apply</button>
            </div>
        </div>
    </div>


            <script>
                   // Global State
                const state = {
                lastPrice: 0,
                lastTradeWasBuy: false,
                orderBook: { bids: [], asks: [] },
                trades: [],
                aggTrades: [],
                cumulativeTrades: [],
                marketOrders: [],
                largeOrders: [],
                dpegOrders: [],
                dpegAnalysis: {
                    active: false,
                    buyCount: 0,
                    sellCount: 0,
                    maxBuySlippage: 0,
                    maxSellSlippage: 0,
                    lastAnalysisTime: 0,
                    buyThresh: 0.00006,
                    sellThresh: 0.00008
                },
                vwap: {
                    intraday: { price: 0, poc: 0, val: 0, vah: 0 },
                    daily: { price: 0, poc: 0, val: 0, vah: 0 }
                },
                volume: {
                    buys15m: { btc: 0, usd: 0 },
                    sells15m: { btc: 0, usd: 0 },
                    cvd15m: 0,
                    cvd4h: 0,
                    dpegCvd: { btc: 0, usd: 0, delta: 0 }
                },
                timers: {
                    nextAnalysis: 300,
                    barClose15m: 900,
                    barClose4h: 14400
                },
                volatility: 0,
                ws: null,
                aggWs: null,
                obWs: null,
                lastUpdate: null,
                slippage: { bid: 0, ask: 0 },
                marketUpdates: [
                    ""  // Empty string as placeholder
                ],
                alertColors: {
                    agg1: '#39FF14',
                    agg2: '#FF3131',
                    cumulative1: '#00F5FF',
                    cumulative2: '#BF40BF',
                    market1: '#FFD700',
                    market2: '#00BFFF',
                    large1: '#FFD700',
                    large2: '#00BFFF'
                },
                colorPicker: {
                    active: null,
                    currentColor: null
                },
                tapeSettings: {
                    'trades-panel': { highlightColor: '#1E90FF', transparency: 30 },
                    'agg-trades-panel': { highlightColor: '#39FF14', transparency: 30 },
                    'cumulative-panel': { highlightColor: '#00F5FF', transparency: 30 },
                    'market-orders-panel': { highlightColor: '#BF40BF', transparency: 30 },
                    'dpeg-panel': { highlightColor: '#FF3131', transparency: 30 },
                    'large-orders-panel': { highlightColor: '#FFD700', transparency: 30 }
                }
            };

            function updateOrderBook(data) {
                const bids = data.b || data.bids || [];
                bids.forEach(bid => {
                    const price = parseFloat(bid[0]);
                    const amount = parseFloat(bid[1]);
                    
                    if (amount === 0) {
                        state.orderBook.bids = state.orderBook.bids.filter(b => b.price !== price);
                    } else {
                        const existing = state.orderBook.bids.find(b => b.price === price);
                        if (existing) {
                            existing.amount = amount;
                        } else {
                            state.orderBook.bids.push({ price, amount });
                        }
                    }
                });
                
                const asks = data.a || data.asks || [];
                asks.forEach(ask => {
                    const price = parseFloat(ask[0]);
                    const amount = parseFloat(ask[1]);
                    
                    if (amount === 0) {
                        state.orderBook.asks = state.orderBook.asks.filter(a => a.price !== price);
                    } else {
                        const existing = state.orderBook.asks.find(a => a.price === price);
                        if (existing) {
                            existing.amount = amount;
                        } else {
                            state.orderBook.asks.push({ price, amount });
                        }
                    }
                });
                
                state.orderBook.bids.sort((a, b) => b.price - a.price);
                state.orderBook.asks.sort((a, b) => a.price - b.price);
                
                updateSlippageIndicators();
            }

            function processAggTrade(aggTrade) {
                const price = parseFloat(aggTrade.p);
                const size = parseFloat(aggTrade.q);
                const isBuy = !aggTrade.m;
                const time = new Date(aggTrade.T);
                const value = price * size;
                
                const tradeObj = { price, size, isBuy, time, value };
                state.aggTrades.unshift(tradeObj);
                if (state.aggTrades.length > 200) state.aggTrades.pop();
                
                updateAggTradesTape();
            }

            function updateTimeAndSalesTape() {
                const container = document.getElementById('trades-tape');
                if (!container) return;
                
                container.innerHTML = state.trades.slice(0, 50).map(trade => {
                    const timeStr = trade.time.toLocaleTimeString();
                    return `
                        <div class="tape-item">
                            <span class="tape-time">${timeStr}</span>
                            <span class="tape-price ${trade.isBuy ? 'positive-value' : 'negative-value'}">
                                ${trade.price.toFixed(2)}
                            </span>
                            <span class="tape-size">${trade.size.toFixed(4)}</span>
                        </div>
                    `;
                }).join('');
            }

            function updateAggTradesTape() {
                const container = document.getElementById('agg-trades-tape');
                if (!container) return;
                
                container.innerHTML = state.aggTrades.slice(0, 50).map(trade => {
                    const timeStr = trade.time.toLocaleTimeString();
                    return `
                        <div class="tape-item">
                            <span class="tape-time">${timeStr}</span>
                            <span class="tape-price ${trade.isBuy ? 'positive-value' : 'negative-value'}">
                                ${trade.price.toFixed(2)}
                            </span>
                            <span class="tape-size">${trade.size.toFixed(4)}</span>
                        </div>
                    `;
                }).join('');
            }

            function updateDPegTape() {
                const container = document.getElementById('dpeg-tape');
                if (!container) return;
                
                container.innerHTML = state.dpegOrders.map(trade => {
                    const timeStr = trade.time.toLocaleTimeString();
                    const slippage = trade.isBuy 
                        ? trade.price / state.orderBook.asks[0].price - 1
                        : 1 - trade.price / state.orderBook.bids[0].price;
                        
                    return `
                        <div class="tape-item" style="background-color: rgba(255, 49, 49, 0.3)">
                            <span class="tape-time">${timeStr}</span>
                            <span class="tape-price ${trade.isBuy ? 'positive-value' : 'negative-value'}">
                                ${trade.price.toFixed(2)}
                            </span>
                            <span class="tape-slippage">${(slippage * 100).toFixed(2)}%</span>
                        </div>
                    `;
                }).join('');
            }

            function updateMarketOrdersTape() {
                const container = document.getElementById('market-orders-tape');
                if (!container) return;
                
                container.innerHTML = state.marketOrders.slice(0, 50).map(trade => {
                    const timeStr = trade.time.toLocaleTimeString();
                    return `
                        <div class="tape-item">
                            <span class="tape-time">${timeStr}</span>
                            <span class="tape-price ${trade.isBuy ? 'positive-value' : 'negative-value'}">
                                ${trade.price.toFixed(2)}
                            </span>
                            <span class="tape-size">${trade.size.toFixed(4)}</span>
                        </div>
                    `;
                }).join('');
            }

            function updateLargeOrdersTape() {
                const container = document.getElementById('large-orders-tape');
                if (!container) return;
                
                container.innerHTML = state.largeOrders.map(trade => {
                    const timeStr = trade.time.toLocaleTimeString();
                    return `
                        <div class="tape-item">
                            <span class="tape-time">${timeStr}</span>
                            <span class="tape-price ${trade.isBuy ? 'positive-value' : 'negative-value'}">
                                ${trade.price.toFixed(2)}
                            </span>
                            <span class="tape-size">${trade.size.toFixed(4)}</span>
                            <span class="tape-value">$${(trade.value/1000).toFixed(1)}k</span>
                        </div>
                    `;
                }).join('');
            }

            function updateSlippageIndicators() {
                if (state.orderBook.bids.length === 0 || state.orderBook.asks.length === 0) return;
                
                const bestBid = state.orderBook.bids[0].price;
                const bestAsk = state.orderBook.asks[0].price;
                
                const usdAmount = 100000;
                const btcAmount = usdAmount / state.lastPrice;
                
                let buySlippage = 0;
                let remaining = btcAmount;
                for (let i = 0; i < state.orderBook.asks.length && remaining > 0; i++) {
                    const level = state.orderBook.asks[i];
                    const taken = Math.min(level.amount, remaining);
                    buySlippage += taken * (level.price - bestAsk);
                    remaining -= taken;
                }
                
                let sellSlippage = 0;
                remaining = btcAmount;
                for (let i = 0; i < state.orderBook.bids.length && remaining > 0; i++) {
                    const level = state.orderBook.bids[i];
                    const taken = Math.min(level.amount, remaining);
                    sellSlippage += taken * (bestBid - level.price);
                    remaining -= taken;
                }
                
                state.slippage.bid = sellSlippage / btcAmount;
                state.slippage.ask = buySlippage / btcAmount;
                
                document.getElementById('bid-slippage').textContent = state.slippage.bid.toFixed(4);
                document.getElementById('ask-slippage').textContent = state.slippage.ask.toFixed(4);
            }

            const SocketManager = {
                sockets: {},
                reconnectAttempts: {},
                maxReconnectAttempts: 5,
                reconnectDelay: 5000,
                
                createSocket: function(type, stream) {
                    if (this.sockets[type]) {
                        this.sockets[type].close();
                    }
                    
                    const url = `wss://stream.binance.com:9443/ws/${stream}`;
                    this.sockets[type] = new WebSocket(url);
                    this.reconnectAttempts[type] = 0;
                    
                    this.sockets[type].onopen = () => {
                        console.log(`${type} WebSocket connected`);
                        this.reconnectAttempts[type] = 0;
                        this.updateConnectionStatus(type, 'connected');
                        this.showConnectionMessage(type, 'connected');
                    };
                    
                    this.sockets[type].onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            
                            if (data.ping) {
                                this.handlePing(type, data.ping);
                                return;
                            }
                            
                            this.routeData(type, data);
                        } catch (e) {
                            console.error(`${type} message processing error:`, e);
                        }
                    };
                    
                    this.sockets[type].onclose = (event) => {
                        console.log(`${type} WebSocket closed`, event);
                        const status = event.code === 1000 ? 'disconnected' : 'reconnecting';
                        this.updateConnectionStatus(type, status);
                        this.showConnectionMessage(type, status);
                        
                        if (event.code !== 1000) {
                            this.attemptReconnect(type, stream);
                        }
                    };
                    
                    this.sockets[type].onerror = (error) => {
                        console.error(`${type} WebSocket error:`, error);
                        this.updateConnectionStatus(type, 'error');
                        this.showConnectionMessage(type, 'failed');
                    };
                },
                
                handlePing: function(type, pingValue) {
                    if (this.sockets[type]?.readyState === WebSocket.OPEN) {
                        try {
                            this.sockets[type].send(JSON.stringify({ pong: pingValue }));
                        } catch (e) {
                            console.error(`${type} pong failed:`, e);
                        }
                    }
                },
                
                attemptReconnect: function(type, stream) {
                    if (this.reconnectAttempts[type] < this.maxReconnectAttempts) {
                        this.reconnectAttempts[type]++;
                        console.log(`Attempting to reconnect ${type} (attempt ${this.reconnectAttempts[type]})`);
                        this.showConnectionMessage(type, 'reconnecting');
                        
                        setTimeout(() => {
                            this.createSocket(type, stream);
                        }, this.reconnectDelay);
                    } else {
                        console.error(`Max reconnection attempts reached for ${type}`);
                        this.showConnectionMessage(type, 'failed');
                    }
                },
                
                updateConnectionStatus: function(type, status) {
                    const element = document.getElementById(`${type}-status`);
                    if (!element) return;
                    
                    element.className = `connection-status ${status}`;
                    element.textContent = {
                        connected: '● Connected',
                        disconnected: '○ Disconnected',
                        error: '⚠ Error',
                        reconnecting: '↻ Reconnecting'
                    }[status];
                    
                    const panelHeader = element.closest('.panel-header');
                    if (panelHeader) {
                        panelHeader.classList.remove('connection-lost', 'reconnecting');
                        if (status === 'disconnected') panelHeader.classList.add('connection-lost');
                        if (status === 'reconnecting') panelHeader.classList.add('reconnecting');
                    }
                },
                
                showConnectionMessage: function(type, status) {
                    const typeName = type === 'trade' ? 'Trade' : 
                                   type === 'aggTrade' ? 'Aggregated Trade' : 
                                   type === 'orderbook' ? 'Order Book' : type;
                    
                    let message = '';
                    if (status === 'disconnected') {
                        message = `⚠️ ${typeName} stream disconnected - attempting to reconnect...`;
                    } 
                    else if (status === 'reconnecting') {
                        message = `↻ ${typeName} stream reconnecting...`;
                    }
                    else if (status === 'connected') {
                        message = `✓ ${typeName} stream connected`;
                        setTimeout(() => {
                            document.getElementById('market-updates').textContent = state.marketUpdates[0];
                        }, 3000);
                    }
                    else if (status === 'failed') {
                        message = `❌ ${typeName} stream connection failed after multiple attempts`;
                    }
                    
                    if (message) {
                        document.getElementById('market-updates').innerHTML = 
                            `<span style="color:${
                                status === 'connected' ? '#39FF14' : 
                                status === 'failed' ? '#FF3131' : '#FFA500'
                            }">${message}</span>`;
                    }
                },
                
                routeData: function(type, data) {
                    switch (type) {
                        case 'trade':
                            if (data.e === 'trade') {
                                processTrade(data);
                            }
                            break;
                            
                        case 'aggTrade':
                            if (data.e === 'aggTrade') {
                                processAggTrade(data);
                            }
                            break;
                            
                        case 'orderbook':
                            updateOrderBook(data);
                            break;
                    }
                }
            };

            function setupEnhancedColorPickers() {
                const colorPalette = [
                    '#FF3131', '#39FF14', '#00F5FF', '#BF40BF', '#FFD700', '#00BFFF',
                    '#FF8C00', '#7CFC00', '#FF00FF', '#00FF7F', '#1E90FF', '#FF6347',
                    '#9400D3', '#4B0082', '#0000FF', '#00FF00', '#FFFF00', '#FF7F00',
                    '#FF0000', '#8B0000', '#A9A9A9', '#696969', '#000000', '#FFFFFF'
                ];

                const paletteContainer = document.getElementById('color-palette');
                paletteContainer.innerHTML = colorPalette.map(color => `
                    <div class="color-option" style="background-color: ${color}" data-color="${color}"></div>
                `).join('');

                document.querySelectorAll('.panel').forEach(panel => {
                    const header = panel.querySelector('.panel-header');
                    if (header) {
                        const btn = document.createElement('button');
                        btn.className = 'tape-controls-btn';
                        btn.textContent = '✎ Filters';
                        btn.onclick = () => showTapeControlsModal(panel.id);
                        header.appendChild(btn);
                    }
                });

                setupColorPickerEvents();
            }

            function showTapeControlsModal(panelId) {
                const modal = document.getElementById('color-modal');
                const panel = document.getElementById(panelId);
                const settings = state.tapeSettings[panelId] || {};
                
                modal.dataset.currentPanel = panelId;
                
                modal.querySelector('h3').textContent = `${panel.querySelector('.panel-header span').textContent} Controls`;
                
                document.querySelectorAll('.color-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.style.backgroundColor === `rgb(${hexToRgb(settings.highlightColor)})`) {
                        opt.classList.add('selected');
                    }
                });
                
                document.getElementById('transparency-slider').value = settings.transparency || 30;
                
                const filtersContainer = modal.querySelector('#dynamic-filters');
                filtersContainer.innerHTML = '';
                
                if (panelId.includes('agg-trades') || panelId.includes('market-orders') || panelId.includes('large-orders')) {
                    filtersContainer.innerHTML = `
                        <div class="filter-group-modal">
                            <label class="filter-label-modal">Min Size:</label>
                            <input type="number" class="filter-input" id="filter-min-size" step="0.0001" value="${settings.minSize || ''}">
                        </div>
                        <div class="filter-group-modal">
                            <label class="filter-label-modal">Max Size:</label>
                            <input type="number" class="filter-input" id="filter-max-size" step="0.0001" value="${settings.maxSize || ''}">
                        </div>
                        <div class="filter-group-modal">
                            <label class="filter-label-modal">Alert 1:</label>
                            <select class="filter-select" id="filter-alert-type1">
                                <option value="none">None</option>
                                <option value="bid">Bid</option>
                                <option value="ask">Ask</option>
                                <option value="volume">Volume</option>
                            </select>
                            <input type="number" class="filter-input" id="filter-alert-min1" placeholder="Min" value="${settings.alert1Min || ''}">
                        </div>
                        <div class="filter-group-modal">
                            <label class="filter-label-modal">Alert 2:</label>
                            <select class="filter-select" id="filter-alert-type2">
                                <option value="none">None</option>
                                <option value="bid">Bid</option>
                                <option value="ask">Ask</option>
                                <option value="volume">Volume</option>
                            </select>
                            <input type="number" class="filter-input" id="filter-alert-min2" placeholder="Min" value="${settings.alert2Min || ''}">
                        </div>
                    `;
                    
                    if (settings.alert1Type) {
                        document.getElementById('filter-alert-type1').value = settings.alert1Type;
                    }
                    if (settings.alert2Type) {
                        document.getElementById('filter-alert-type2').value = settings.alert2Type;
                    }
                } else if (panelId.includes('dpeg')) {
                    filtersContainer.innerHTML = `
                        <div class="filter-group-modal">
                            <label class="filter-label-modal">Buy Threshold:</label>
                            <input type="number" class="filter-input" id="dpeg-buy-thresh" value="${state.dpegAnalysis.buyThresh || 0.00006}" step="0.00001">
                        </div>
                        <div class="filter-group-modal">
                            <label class="filter-label-modal">Sell Threshold:</label>
                            <input type="number" class="filter-input" id="dpeg-sell-thresh" value="${state.dpegAnalysis.sellThresh || 0.00008}" step="0.00001">
                        </div>
                    `;
                }
                
                modal.style.display = 'block';
            }

            function setupColorPickerEvents() {
                const modal = document.getElementById('color-modal');
                
                document.querySelectorAll('.color-option').forEach(option => {
                    option.addEventListener('click', function() {
                        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                    });
                });
                
                document.getElementById('color-confirm').addEventListener('click', function() {
                    const panelId = modal.dataset.currentPanel;
                    const selectedColor = document.querySelector('.color-option.selected')?.style.backgroundColor;
                    const transparency = document.getElementById('transparency-slider').value;
                    
                    if (panelId) {
                        state.tapeSettings[panelId] = state.tapeSettings[panelId] || {};
                        state.tapeSettings[panelId].highlightColor = selectedColor;
                        state.tapeSettings[panelId].transparency = transparency;
                        
                        if (panelId.includes('agg-trades') || panelId.includes('market-orders') || panelId.includes('large-orders')) {
                            state.tapeSettings[panelId].minSize = document.getElementById('filter-min-size').value;
                            state.tapeSettings[panelId].maxSize = document.getElementById('filter-max-size').value;
                            state.tapeSettings[panelId].alert1Type = document.getElementById('filter-alert-type1').value;
                            state.tapeSettings[panelId].alert1Min = document.getElementById('filter-alert-min1').value;
                            state.tapeSettings[panelId].alert2Type = document.getElementById('filter-alert-type2').value;
                            state.tapeSettings[panelId].alert2Min = document.getElementById('filter-alert-min2').value;
                        } else if (panelId.includes('dpeg')) {
                            state.dpegAnalysis.buyThresh = parseFloat(document.getElementById('dpeg-buy-thresh').value);
                            state.dpegAnalysis.sellThresh = parseFloat(document.getElementById('dpeg-sell-thresh').value);
                        }
                        
                        updateTapeWithSettings(panelId);
                    }
                    
                    modal.style.display = 'none';
                });
                
                document.getElementById('color-cancel').addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }

            function updateTapeWithSettings(panelId) {
                const settings = state.tapeSettings[panelId];
                if (!settings) return;
                
                console.log(`Updating ${panelId} with settings:`, settings);
                
                if (panelId === 'agg-trades-panel') {
                    updateAggTradesTape();
                }
            }

            function hexToRgb(hex) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `${r}, ${g}, ${b}`;
            }

            function processTrade(trade) {
                const price = parseFloat(trade.p);
                const size = parseFloat(trade.q);
                const isBuy = !trade.m;
                const time = new Date(trade.T);
                const value = price * size;
                
                state.lastPrice = price;
                state.lastTradeWasBuy = isBuy;
                updatePriceDisplay(price, isBuy);
                
                routeTradeToTapes({
                    price, size, isBuy, time, value, rawData: trade
                });
            }

            function routeTradeToTapes(tradeObj) {
                addToTimeAndSales(tradeObj);
                
                if (isDPegTrade(tradeObj)) {
                    processDPegTrade(tradeObj);
                }
                
                if (isMarketOrder(tradeObj.rawData)) {
                    addToMarketOrders(tradeObj);
                }
                
                if (isLargeOrder(tradeObj)) {
                    addToLargeOrders(tradeObj);
                }
                
                updateVolumeMetrics(tradeObj);
            }

            function addToTimeAndSales(trade) {
                state.trades.unshift(trade);
                if (state.trades.length > 200) state.trades.pop();
                updateTimeAndSalesTape();
            }

            function isDPegTrade(trade) {
                if (!state.dpegAnalysis.active) return false;
                
                const { price, isBuy } = trade;
                const bestBid = state.orderBook.bids[0]?.price || price;
                const bestAsk = state.orderBook.asks[0]?.price || price;
                
                if (isBuy) {
                    return price > bestAsk * (1 + state.dpegAnalysis.buyThresh);
                } else {
                    return price < bestBid * (1 - state.dpegAnalysis.sellThresh);
                }
            }

            function processDPegTrade(trade) {
                state.dpegOrders.unshift(trade);
                if (state.dpegOrders.length > 50) state.dpegOrders.pop();
                
                const delta = trade.isBuy ? trade.size : -trade.size;
                state.volume.dpegCvd.btc += delta;
                state.volume.dpegCvd.usd += delta * trade.price;
                state.volume.dpegCvd.delta = delta;
                
                updateDPegTape();
            }

            function isMarketOrder(trade) {
                if (state.orderBook.bids.length === 0 || state.orderBook.asks.length === 0) return false;
                
                if (trade.m === true) {
                    return parseFloat(trade.p) <= state.orderBook.bids[0].price;
                } else {
                    return parseFloat(trade.p) >= state.orderBook.asks[0].price;
                }
            }

            function addToMarketOrders(trade) {
                state.marketOrders.unshift(trade);
                if (state.marketOrders.length > 100) state.marketOrders.pop();
                updateMarketOrdersTape();
            }

            function isLargeOrder(trade) {
                const largeMin = parseFloat(document.getElementById('large-min').value) || 5;
                const largeMax = parseFloat(document.getElementById('large-max').value) || 1000;
                return trade.size >= largeMin && trade.size <= largeMax;
            }

            function addToLargeOrders(trade) {
                state.largeOrders.unshift(trade);
                if (state.largeOrders.length > 50) state.largeOrders.pop();
                updateLargeOrdersTape();
            }

            function updatePriceDisplay(price, isBuy) {
                const priceDisplay = document.getElementById('last-price-display');
                if (priceDisplay) {
                    priceDisplay.className = isBuy ? 'positive-value' : 'negative-value';
                    priceDisplay.textContent = price.toFixed(2);
                }
            }

            function updateVolumeMetrics(trade) {
                const fifteenMinutesAgo = Date.now() - (15 * 60 * 1000);
                
                const recentTrades = state.trades.filter(t => 
                    t.time.getTime() > fifteenMinutesAgo
                );
                
                let buyVol = 0;
                let sellVol = 0;
                
                recentTrades.forEach(t => {
                    if (t.isBuy) {
                        buyVol += t.size;
                    } else {
                        sellVol += t.size;
                    }
                });
                
                state.volume.buys15m.btc = buyVol;
                state.volume.sells15m.btc = sellVol;
                state.volume.buys15m.usd = buyVol * state.lastPrice;
                state.volume.sells15m.usd = sellVol * state.lastPrice;
                state.volume.cvd15m = buyVol - sellVol;
                
                const safeUpdate = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };
                
                safeUpdate('buy-volume-15m', buyVol.toFixed(4));
                safeUpdate('sell-volume-15m', sellVol.toFixed(4));
                safeUpdate('net-volume-15m', state.volume.cvd15m.toFixed(4));
                safeUpdate('buy-value-15m', `$${(state.volume.buys15m.usd/1000).toFixed(1)}k`);
                safeUpdate('sell-value-15m', `$${(state.volume.sells15m.usd/1000).toFixed(1)}k`);
            }

            function updateAggTradesTape() {
                const container = document.getElementById('agg-trades-tape');
                if (!container) return;
                
                const settings = state.tapeSettings['agg-trades-panel'] || {};
                const highlightColor = settings.highlightColor || '#39FF14';
                const transparency = settings.transparency || 30;
                
                container.innerHTML = state.aggTrades.slice(0, 50).map(trade => {
                    const timeStr = trade.time.toLocaleTimeString();
                    const sizeClass = trade.size >= 10 ? 'large-trade' : '';
                    const highlight = trade.isBuy ? 
                        `style="background-color: rgba(${hexToRgb(highlightColor)}, ${transparency}%)"` : '';
                    
                    return `
                        <div class="tape-item ${sizeClass}" ${highlight}>
                            <span class="tape-time">${timeStr}</span>
                            <span class="tape-price ${trade.isBuy ? 'positive-value' : 'negative-value'}">
                                ${trade.price.toFixed(2)}
                            </span>
                            <span class="tape-size">${trade.size.toFixed(4)}</span>
                        </div>
                    `;
                }).join('');
            }

            function updateLargeOrdersTape() {
                const container = document.getElementById('large-orders-tape');
                if (!container) return;
                
                const settings = state.tapeSettings['large-orders-panel'] || {};
                const highlightColor = settings.highlightColor || '#FFD700';
                const transparency = settings.transparency || 30;
                
                container.innerHTML = state.largeOrders.map(trade => {
                    const timeStr = trade.time.toLocaleTimeString();
                    const highlight = trade.isBuy ? 
                        `style="background-color: rgba(${hexToRgb(highlightColor)}, ${transparency}%)"` : '';
                    
                    return `
                        <div class="tape-item" ${highlight}>
                            <span class="tape-time">${timeStr}</span>
                            <span class="tape-price ${trade.isBuy ? 'positive-value' : 'negative-value'}">
                                ${trade.price.toFixed(2)}
                            </span>
                            <span class="tape-size">${trade.size.toFixed(4)}</span>
                            <span class="tape-value">$${(trade.value/1000).toFixed(1)}k</span>
                        </div>
                    `;
                }).join('');
            }

            function updateMarketOrdersTape() {
                const container = document.getElementById('market-orders-tape');
                if (!container) return;
                
                const settings = state.tapeSettings['market-orders-panel'] || {};
                const highlightColor = settings.highlightColor || '#BF40BF';
                const transparency = settings.transparency || 30;
                
                container.innerHTML = state.marketOrders.slice(0, 50).map(trade => {
                    const timeStr = trade.time.toLocaleTimeString();
                    const highlight = trade.isBuy ? 
                        `style="background-color: rgba(${hexToRgb(highlightColor)}, ${transparency}%)"` : '';
                    
                    return `
                        <div class="tape-item" ${highlight}>
                            <span class="tape-time">${timeStr}</span>
                            <span class="tape-price ${trade.isBuy ? 'positive-value' : 'negative-value'}">
                                ${trade.price.toFixed(2)}
                            </span>
                            <span class="tape-size">${trade.size.toFixed(4)}</span>
                        </div>
                    `;
                }).join('');
            }

            function updateCumulativeTape() {
                const container = document.getElementById('cumulative-tape');
                if (!container) return;
                
                const settings = state.tapeSettings['cumulative-panel'] || {};
                const highlightColor = settings.highlightColor || '#00F5FF';
                const transparency = settings.transparency || 30;
                
                let buyVolume = 0;
                let sellVolume = 0;
                
                state.cumulativeTrades.forEach(trade => {
                    if (trade.isBuy) {
                        buyVolume += trade.size;
                    } else {
                        sellVolume += trade.size;
                    }
                });
                
                container.innerHTML = `
                    <div class="tape-item">
                        <span class="tape-label">Total Buy Volume:</span>
                        <span class="tape-value positive-value">${buyVolume.toFixed(4)}</span>
                    </div>
                    <div class="tape-item">
                        <span class="tape-label">Total Sell Volume:</span>
                        <span class="tape-value negative-value">${sellVolume.toFixed(4)}</span>
                    </div>
                    <div class="tape-item">
                        <span class="tape-label">Net Volume:</span>
                        <span class="tape-value ${buyVolume > sellVolume ? 'positive-value' : 'negative-value'}">
                            ${(buyVolume - sellVolume).toFixed(4)}
                        </span>
                    </div>
                `;
            }

            function updateSlippageIndicators() {
                if (state.orderBook.bids.length === 0 || state.orderBook.asks.length === 0) return;
                
                const bestBid = state.orderBook.bids[0].price;
                const bestAsk = state.orderBook.asks[0].price;
                
                const usdAmount = 100000;
                const btcAmount = usdAmount / state.lastPrice;
                
                let buySlippage = 0;
                let remaining = btcAmount;
                for (let i = 0; i < state.orderBook.asks.length && remaining > 0; i++) {
                    const level = state.orderBook.asks[i];
                    const taken = Math.min(level.amount, remaining);
                    buySlippage += taken * (level.price - bestAsk);
                    remaining -= taken;
                }
                
                let sellSlippage = 0;
                remaining = btcAmount;
                for (let i = 0; i < state.orderBook.bids.length && remaining > 0; i++) {
                    const level = state.orderBook.bids[i];
                    const taken = Math.min(level.amount, remaining);
                    sellSlippage += taken * (bestBid - level.price);
                    remaining -= taken;
                }
                
                state.slippage.bid = sellSlippage / btcAmount;
                state.slippage.ask = buySlippage / btcAmount;
                
                safeUpdate('bid-slippage', state.slippage.bid.toFixed(4));
                safeUpdate('ask-slippage', state.slippage.ask.toFixed(4));
            }

            function updateVolumeMetrics(trade) {
                const fifteenMinutesAgo = Date.now() - (15 * 60 * 1000);
                
                const recentTrades = state.cumulativeTrades.filter(t => 
                    t.time.getTime() > fifteenMinutesAgo
                );
                
                let buyVol = 0;
                let sellVol = 0;
                
                recentTrades.forEach(t => {
                    if (t.isBuy) {
                        buyVol += t.size;
                    } else {
                        sellVol += t.size;
                    }
                });
                
                state.volume.buys15m.btc = buyVol;
                state.volume.sells15m.btc = sellVol;
                state.volume.buys15m.usd = buyVol * state.lastPrice;
                state.volume.sells15m.usd = sellVol * state.lastPrice;
                state.volume.cvd15m = buyVol - sellVol;
                
                safeUpdate('buys-15m', buyVol.toFixed(4));
                safeUpdate('sells-15m', sellVol.toFixed(4));
                safeUpdate('buys-15m-usd', `$${(state.volume.buys15m.usd).toLocaleString()}`);
                safeUpdate('sells-15m-usd', `$${(state.volume.sells15m.usd).toLocaleString()}`);
                safeUpdate('dpeg-cvd', state.volume.dpegCvd.btc.toFixed(6));
                safeUpdate('dpeg-cvd-usd', `$${Math.abs(state.volume.dpegCvd.usd).toLocaleString()}`);
            }

            function updateInfoPanel() {
                safeUpdate('intraday-vwap', state.vwap.intraday.price.toFixed(2));
                safeUpdate('daily-vwap', state.vwap.daily.price.toFixed(2));
            }

            function safeUpdate(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            }

            function rotateMarketUpdates() {
                if (state.marketUpdates.length === 0) return;
                
                const updateContainer = document.getElementById('market-updates');
                if (!updateContainer) return;
                
                const currentIndex = state.marketUpdates.indexOf(updateContainer.textContent);
                const nextIndex = (currentIndex + 1) % state.marketUpdates.length;
                
                updateContainer.textContent = state.marketUpdates[nextIndex];
            }

            function makePanelsDraggable() {
                document.querySelectorAll('.panel-header').forEach(header => {
                    header.addEventListener('mousedown', function(e) {
                        const panel = this.closest('.panel');
                        const offsetX = e.clientX - panel.getBoundingClientRect().left;
                        const offsetY = e.clientY - panel.getBoundingClientRect().top;
                        
                        function movePanel(e) {
                            panel.style.left = (e.clientX - offsetX) + 'px';
                            panel.style.top = (e.clientY - offsetY) + 'px';
                        }
                        
                        function stopMoving() {
                            document.removeEventListener('mousemove', movePanel);
                            document.removeEventListener('mouseup', stopMoving);
                        }
                        
                        document.addEventListener('mousemove', movePanel);
                        document.addEventListener('mouseup', stopMoving);
                    });
                });
            }

            function startTimers() {
                setInterval(() => {
                    state.timers.nextAnalysis--;
                    state.timers.barClose15m--;
                    state.timers.barClose4h--;
                    
                    safeUpdate('next-analysis', formatTime(state.timers.nextAnalysis));
                    safeUpdate('bar-close-15m', formatTime(state.timers.barClose15m));
                    safeUpdate('bar-close-4h', formatTime(state.timers.barClose4h));
                    
                    if (state.timers.nextAnalysis <= 0) {
                        state.timers.nextAnalysis = 300;
                        runDpegAnalysis();
                    }
                    if (state.timers.barClose15m <= 0) {
                        state.timers.barClose15m = 900;
                        reset15mVolume();
                    }
                    if (state.timers.barClose4h <= 0) {
                        state.timers.barClose4h = 14400;
                        reset4hVolume();
                    }
                }, 1000);
            }

            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }

            function runDpegAnalysis() {
                const recentTrades = state.cumulativeTrades.filter(t => 
                    t.time.getTime() > Date.now() - 300000
                );
                
                let buyCount = 0;
                let sellCount = 0;
                let maxBuySlippage = 0;
                let maxSellSlippage = 0;
                
                recentTrades.forEach(t => {
                    if (t.isBuy) {
                        buyCount++;
                        if (t.price > state.orderBook.asks[0].price * (1 + state.dpegAnalysis.buyThresh)) {
                            maxBuySlippage = Math.max(maxBuySlippage, 
                                t.price - state.orderBook.asks[0].price);
                        }
                    } else {
                        sellCount++;
                        if (t.price < state.orderBook.bids[0].price * (1 - state.dpegAnalysis.sellThresh)) {
                            maxSellSlippage = Math.max(maxSellSlippage, 
                                state.orderBook.bids[0].price - t.price);
                        }
                    }
                });
                
                state.dpegAnalysis.buyCount = buyCount;
                state.dpegAnalysis.sellCount = sellCount;
                state.dpegAnalysis.maxBuySlippage = maxBuySlippage;
                state.dpegAnalysis.maxSellSlippage = maxSellSlippage;
                state.dpegAnalysis.lastAnalysisTime = Date.now();
                
                const totalTrades = buyCount + sellCount;
                if (totalTrades > 0) {
                    const buyRatio = buyCount / totalTrades;
                    const sellRatio = sellCount / totalTrades;
                    
                    state.dpegAnalysis.active = 
                        buyRatio > 0.65 || sellRatio > 0.65 || 
                        maxBuySlippage > 0 || maxSellSlippage > 0;
                } else {
                    state.dpegAnalysis.active = false;
                }
            }

            function reset15mVolume() {
                state.volume.buys15m = { btc: 0, usd: 0 };
                state.volume.sells15m = { btc: 0, usd: 0 };
                state.volume.cvd15m = 0;
                updateVolumeMetrics();
            }

            function reset4hVolume() {
                state.volume.cvd4h = state.volume.cvd15m;
                safeUpdate('cvd-4h', state.volume.cvd4h.toFixed(4));
            }

            function setupEventListeners() {
                document.getElementById('large-min')?.addEventListener('change', function() {
                    updateLargeOrdersTape();
                });
                
                document.getElementById('large-max')?.addEventListener('change', function() {
                    updateLargeOrdersTape();
                });
                
                document.getElementById('dpeg-buy-thresh')?.addEventListener('change', function() {
                    state.dpegAnalysis.buyThresh = parseFloat(this.value);
                });

                document.getElementById('dpeg-sell-thresh')?.addEventListener('change', function() {
                    state.dpegAnalysis.sellThresh = parseFloat(this.value);
                });

                document.getElementById('start-dpeg')?.addEventListener('click', function() {
                    state.dpegAnalysis.active = !state.dpegAnalysis.active;
                    this.textContent = state.dpegAnalysis.active ? 'CVD Running' : 'Start CVD';
                    this.style.backgroundColor = state.dpegAnalysis.active 
                        ? 'rgba(0, 255, 0, 0.2)' 
                        : 'rgba(255, 0, 0, 0.2)';
                    if (state.dpegAnalysis.active) runDpegAnalysis();
                });
            }

            function initDashboard() {
                // Initialize UI elements
                safeUpdate('trades-tape', '<div class="tape-empty">Waiting for trades...</div>');
                safeUpdate('dpeg-tape', '<div class="tape-empty">DPeg analysis inactive</div>');
                
                // Setup functionality
                makePanelsDraggable();
                setupEventListeners();
                setupWebSockets();
                
                // Start processes
                fetchInitialData();
                startTimers();
                setInterval(rotateMarketUpdates, 10000);
            }

            function setupWebSockets() {
                SocketManager.createSocket('trade', 'btcusdt@trade');
                SocketManager.createSocket('aggTrade', 'btcusdt@aggTrade');
                SocketManager.createSocket('orderbook', 'btcusdt@depth@100ms');
            }

            function fetchInitialData() {
                fetch('https://api.binance.com/api/v3/trades?symbol=BTCUSDT&limit=100')
                    .then(res => res.json())
                    .then(trades => {
                        trades.reverse().forEach(trade => {
                            const tradeObj = {
                                e: "trade",
                                E: trade.time,
                                s: "BTCUSDT",
                                t: trade.id,
                                p: trade.price,
                                q: trade.qty,
                                T: trade.time,
                                m: trade.isBuyerMaker,
                                M: true
                            };

                            if (!state.lastPrice) state.lastPrice = parseFloat(trade.price);
                            processTrade(tradeObj);
                        });
                        updateTimeAndSalesTape();
                    });

                fetch('https://api.binance.com/api/v3/aggTrades?symbol=BTCUSDT&limit=100')
                    .then(res => res.json())
                    .then(aggTrades => {
                        aggTrades.reverse().forEach(aggTrade => {
                            processAggTrade({
                                e: "aggTrade",
                                E: aggTrade.time,
                                s: "BTCUSDT",
                                a: aggTrade.aggTradeId,
                                p: aggTrade.price,
                                q: aggTrade.qty,
                                f: aggTrade.firstTradeId,
                                l: aggTrade.lastTradeId,
                                T: aggTrade.time,
                                m: aggTrade.isBuyerMaker,
                                M: true
                            });
                        });
                        updateAggTradesTape();
                    });

                fetch('https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=20')
                    .then(res => res.json())
                    .then(data => {
                        state.orderBook.bids = data.bids.map(b => ({ 
                            price: parseFloat(b[0]), 
                            amount: parseFloat(b[1]) 
                        })).sort((a, b) => b.price - a.price);
                        
                        state.orderBook.asks = data.asks.map(a => ({ 
                            price: parseFloat(a[0]), 
                            amount: parseFloat(a[1]) 
                        })).sort((a, b) => a.price - b.price);
                        
                        updateSlippageIndicators();
                    })
                    .catch(err => {
                        console.error('Order book fetch error:', err);
                        const midPrice = state.lastPrice || 50000;
                        state.orderBook = {
                            bids: [{ price: midPrice * 0.999, amount: 1 }],
                            asks: [{ price: midPrice * 1.001, amount: 1 }]
                        };
                    });

                const midPrice = state.lastPrice || 50000;
                state.vwap.intraday = {
                    price: midPrice,
                    poc: midPrice * 0.993,
                    val: midPrice * 0.990,
                    vah: midPrice * 1.005
                };
                
                state.vwap.daily = {
                    price: midPrice * 0.998,
                    poc: midPrice * 0.995,
                    val: midPrice * 0.992,
                    vah: midPrice * 1.008
                };
                
                state.volatility = 8.5 + Math.random() * 3;
            }

            document.addEventListener('DOMContentLoaded', initDashboard); 
            </script>
</body>
</html>     
